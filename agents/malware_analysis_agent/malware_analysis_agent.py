"""Malware Analysis Agent specialized in analyzing malicious software and code.

This agent identifies, analyzes, and reports on malware characteristics, behaviors,
and potential threats posed by suspicious files and code.
"""

import logging
import os
import yaml

from crewai import Agent

from ..base_agent import BaseAgent
from utils.llm_utils import create_llm
from .malware_analysis_tool import MalwareAnalysisTool

logger = logging.getLogger(__name__)


class MalwareAnalysisAgent(BaseAgent):
    """Agent specialized in malware analysis and threat detection.

    Examines suspicious files, code and binaries to determine malicious behaviors
    and potential impact.
    """

    def __init__(self):
        """Initialize the Malware Analysis Agent."""
        super().__init__()
        
        # Load configuration
        config_path = os.path.join(
            os.path.dirname(__file__), 
            "config", 
            "malware_analysis_agent.yaml"
        )
        self.config = self._load_config(config_path)
        
        # Initialize tools
        self.malware_tool = MalwareAnalysisTool()
        
        self.agent = Agent(
            role=self.config["agent"]["role"],
            goal=self.config["agent"]["goal"],
            backstory=self.config["agent"]["backstory"],
            tools=[self.malware_tool],
            verbose=True,
            allow_delegation=False,
            llm=create_llm()
        )
        
        self.agent_name = "MalwareAnalysisAgent"
        self.agent_role = self.config["agent"]["role"]
        self.agent_goal = self.config["agent"]["goal"]
        self.agent_backstory = self.config["agent"]["backstory"]
        
        logger.info("Malware Analysis Agent initialized")
        
    def _load_config(self, config_path):
        """Load the agent configuration from a YAML file.
        
        Args:
            config_path: Path to the configuration file
            
        Returns:
            Dictionary containing the configuration
        """
        try:
            if os.path.exists(config_path):
                with open(config_path, 'r') as f:
                    return yaml.safe_load(f)
            else:
                logger.warning(f"Config file not found at {config_path}. Using defaults.")
                return {
                    "agent": {
                        "role": "Malware Analyst",
                        "goal": "Analyze suspicious code and files to identify malicious capabilities and behaviors.",
                        "backstory": (
                            "An expert malware analyst with years of experience analyzing "
                            "and dissecting malicious code. You excel at identifying malware "
                            "techniques, behaviors and capabilities, providing detailed "
                            "technical assessments of potential threats."
                        )
                    }
                }
        except Exception as e:
            logger.error(f"Error loading config: {e}. Using defaults.")
            return {
                "agent": {
                    "role": "Malware Analyst", 
                    "goal": "Analyze suspicious code and files to identify malicious capabilities and behaviors.",
                    "backstory": (
                        "An expert malware analyst with years of experience analyzing "
                        "and dissecting malicious code. You excel at identifying malware "
                        "techniques, behaviors and capabilities, providing detailed "
                        "technical assessments of potential threats."
                    )
                }
            }
